<view class="container">
  <!-- è‡ªå®šä¹‰é¡¶éƒ¨æ  -->
  <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-row">
      <view class="back-btn" bindtap="goBack">
        <text class="arrow-left">â€¹</text>
      </view>
      <view class="search-bar">
        <text class="search-icon">ğŸ”</text>
        <input class="search-input" placeholder="æœä¸€æœä½ æƒ³åƒçš„" placeholder-style="color:#999;" bindinput="onSearchInput" />
      </view>
      <view class="together-btn">
        <text>æ‹¼</text> ä¸€èµ·ç‚¹
      </view>
      <view class="more-btn">â€¢â€¢â€¢</view>
    </view>
  </view>

  <!-- é—¨åº—ä¿¡æ¯ -->
  <view class="store-header">
    <view class="store-row">
      <view class="store-name-wrap">
        <text class="store-icon">ğŸ¢</text>
        <text class="store-name">çˆ±åå¹¿åœºé¤å…</text>
        <text class="arrow-down">â–¼</text>
      </view>
      <button class="reserve-btn">é¢„çº¦</button>
    </view>
    <view class="store-meta">
      <text class="tag">è‡ªå–</text>
      <text class="address">è·ƒè¿›è·¯36å·çˆ±åå¹¿åœº...</text>
      <text class="distance">2.6km</text>
    </view>
    <view class="menu-tabs">
      <text class="tab active">ç»å…¸èœå•</text>
      <text class="tab">å¤§ç¥å¡</text>
      <text class="tag-red">ä¸“äº«</text>
    </view>
  </view>

  <!-- ç»¿è‰²æç¤ºæ¡ -->
  <view class="tips-bar">
    <text>ğŸƒ çæƒœç²®é£Ÿ æŒ‰éœ€ç‚¹é¤ ğŸƒ</text>
  </view>

  <!-- èœå•ä¸»ä½“ -->
  <view class="menu-body">
    <!-- å·¦ä¾§åˆ†ç±» -->
    <scroll-view scroll-y class="sidebar">
      <block wx:for="{{categories}}" wx:key="id">
        <view class="category-item {{activeCategory === item.id ? 'active' : ''}}" 
              bindtap="switchCategory" 
              data-id="{{item.id}}">
          <view wx:if="{{item.icon}}" class="cat-icon">{{item.icon}}</view>
          <text>{{item.name}}</text>
        </view>
      </block>
    </scroll-view>

    <!-- å³ä¾§åˆ—è¡¨ -->
    <scroll-view scroll-y class="content" scroll-with-animation scroll-into-view="{{toView}}">
      
      <!-- æœç´¢æ¨¡å¼ï¼šæ˜¾ç¤ºæœç´¢ç»“æœ -->
      <block wx:if="{{products.length > 0}}">
        <view class="cat-header">{{currentCategoryName}}</view>
        <block wx:for="{{products}}" wx:key="id" wx:for-item="dish">
          <template is="dishCard" data="{{dish}}"/>
        </block>
      </block>

      <!-- æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰åˆ†ç±» -->
      <block wx:else>
        <block wx:for="{{menuData}}" wx:key="id" wx:for-item="category">
          <!-- åˆ†ç±»é”šç‚¹ ID -->
          <view class="cat-header" id="cat-{{category.id}}">{{category.name}}</view>
          
          <block wx:for="{{category.products}}" wx:key="id" wx:for-item="dish">
             <template is="dishCard" data="{{dish}}"/>
          </block>
        </block>
      </block>

      <view class="spacer"></view>
    </scroll-view>
  </view>

  <!-- å®šä¹‰å•†å“å¡ç‰‡æ¨¡æ¿ -->
  <template name="dishCard">
    <view class="dish-card">
      <image class="dish-img" src="{{dish.image}}" mode="aspectFill"></image>
      <view class="dish-info">
        <view class="dish-title-row">
          <text class="dish-name">{{dish.name}}</text>
        </view>
        <text class="dish-sub">{{dish.description || dish.sub}}</text>
        <view class="price-row">
          <view class="price-wrap">
            <text class="price-real">Â¥<text class="price-big">{{dish.price}}</text></text>
          </view>
          <button class="spec-btn" bindtap="showSpec" data-item="{{dish}}">é€‰è§„æ ¼</button>
        </view>
      </view>
    </view>
  </template>

  <!-- è§„æ ¼é€‰æ‹©å¼¹çª— -->
  <view class="spec-mask" wx:if="{{showSpecModal}}" bindtap="closeSpec"></view>
  <view class="spec-modal" wx:if="{{showSpecModal}}">
    <view class="spec-header">
      <text class="spec-title">{{currentProduct.name}}</text>
      <view class="close-btn" bindtap="closeSpec">Ã—</view>
    </view>
    <scroll-view scroll-y class="spec-content">
      <block wx:for="{{currentProduct.parsedFlavors}}" wx:key="name" wx:for-item="flavor" wx:for-index="fIndex">
        <view class="flavor-group">
          <view class="flavor-name">{{flavor.name}}</view>
          <view class="flavor-opts">
            <block wx:for="{{flavor.options}}" wx:key="*this" wx:for-item="opt">
              <view class="flavor-opt {{flavor.selected === opt ? 'active' : ''}}" 
                    bindtap="selectFlavor" 
                    data-findex="{{fIndex}}" 
                    data-opt="{{opt}}">
                {{opt}}
              </view>
            </block>
          </view>
        </view>
      </block>
    </scroll-view>
    <view class="spec-footer">
      <view class="spec-price">Â¥{{currentProduct.price}}</view>
      <button class="add-cart-btn" bindtap="confirmSpec">åŠ å…¥è´­ç‰©è½¦</button>
    </view>
  </view>

  <!-- è´­ç‰©è½¦è¯¦æƒ…å¼¹çª— -->
  <view class="cart-mask" wx:if="{{showCartDetail}}" bindtap="hideCart"></view>
  <view class="cart-popup" wx:if="{{showCartDetail}}">
    <view class="cart-header">
      <text class="cart-title">è´­ç‰©è½¦</text>
      <view class="cart-clear" bindtap="clearCart">
        <text>ğŸ—‘ æ¸…ç©º</text>
      </view>
    </view>
    <scroll-view scroll-y class="cart-list">
      <block wx:for="{{cartList}}" wx:key="index">
        <view class="cart-item">
          <view class="cart-item-info">
            <text class="cart-item-name">{{item.name}}</text>
            <text wx:if="{{item.specString}}" class="cart-item-spec">{{item.specString}}</text>
            <text class="cart-item-price">Â¥{{item.price}}</text>
          </view>
          <view class="cart-controls">
            <view class="ctrl-btn minus" catchtap="decreaseCart" data-index="{{index}}">-</view>
            <text class="ctrl-num">{{item.quantity}}</text>
            <view class="ctrl-btn plus" catchtap="increaseCart" data-index="{{index}}">+</view>
          </view>
        </view>
      </block>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨è´­ç‰©è½¦ -->
  <view class="cart-bar">
    <view class="cart-left" bindtap="toggleCart">
      <view class="cart-icon-box" style="display: flex; align-items: center; justify-content: center;">
        <text style="font-size: 36rpx;">ğŸ›’</text>
        <view wx:if="{{cartCount > 0}}" class="cart-badge">{{cartCount}}</view>
      </view>
      <view wx:if="{{cartCount > 0}}" class="price-box">
        <text class="currency">Â¥</text>
        <text class="total-price">{{totalPrice}}</text>
      </view>
      <text wx:else class="empty-text">æœªé€‰è´­é¤å“</text>
    </view>
    <view class="coupon-helper">
      <!-- è¿™é‡Œæœ¬æ¥æ˜¯ä¼˜æƒ åŠ©æ‰‹ï¼Œå¯ä»¥æ”¹æˆå»ç»“ç®—æŒ‰é’® -->
      <view class="coupon-text" bindtap="goToPay" wx:if="{{cartCount > 0}}" style="background: #d62f35; color: white; padding: 10rpx 30rpx; border-radius: 40rpx;">
        <text>å»ç»“ç®—</text>
      </view>
      <view class="coupon-text" wx:else>
        <text>ä¼˜æƒ åŠ©æ‰‹</text>
        <text class="coupon-sub">é¢„è®¡çœÂ¥0</text>
      </view>
    </view>
  </view>
</view>